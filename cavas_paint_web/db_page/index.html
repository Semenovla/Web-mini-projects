<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Образец базы данных Web SQL</title>
    <script>
      // Открываем или создаем базу данных
      // var db = openDatabase(
      //   "biology",
      //   "1.0",
      //   "Молекулярная биология",
      //   5 * 1024 * 1024
      // );
      // const sqlite3 = require("sqlite3").verbose();

      // //Удаляем базу данных
      // db.transaction(function (tx) {
      //   // tx.executeSql('DROP TABLE IF EXISTS Molecules');
      // });

      // //Инициализируем базу данных
      // db.transaction(function (tx) {
      //   tx.executeSql(
      //     "CREATE TABLE IF NOT EXISTS Molecules(id integer primary key autoincrement, molname, moldescription, molfunction)"
      //   );
      // });

      const openRequest = indexedDB.open("List-of-Tools", 1);
      let initialTools = [];
      openRequest.onupgradeneeded = function () {
        let db = openRequest.result;
        if (!db.objectStoreNames.contains("tools")) {
          db.createObjectStore("tools", { keyPath: "name" });
        }
      };

      openRequest.onsuccess = function (event) {
        const db = openRequest.result;
        const transaction = db.transaction("tools", "readwrite");

        const store = transaction.objectStore("tools");
        const result = store.getAll();
        result.onsuccess = function () {
          initialTools = [...result.result];
          for (let i = 0; i < initialTools.length; i++) {
            const toolRaw = document.createElement("tr");
            const name = document.createElement("td");
            const number = document.createElement("td");
            const comment = document.createElement("td");
            const removeButton = document.createElement("td");

            name.textContent = initialTools[i].name;
            number.textContent = initialTools[i].number;
            comment.textContent = initialTools[i].comment;
            removeButton.innerHTML =
              '<button onclick="RemoveTool(' +
              `'${initialTools[i].name}'` +
              ')">Удалить инструмент</button>';
            toolRaw.setAttribute("id", "" + initialTools[i].name);
            toolRaw.appendChild(name);
            toolRaw.appendChild(number);
            toolRaw.appendChild(comment);
            toolRaw.appendChild(removeButton);
            document.getElementById("ToolList").appendChild(toolRaw);
          }
        };
      };

      function AddMolecule() {
        const toolName = document.getElementById("toolname").value;
        const toolNumber = document.getElementById("toolNumber").value;
        const toolComment = document.getElementById("toolComment").value;

        const newToolToAdd = {
          name: toolName,
          number: toolNumber,
          comment: toolComment,
        };
        transaction = openRequest.result.transaction("tools", "readwrite");
        const toolsIndex = transaction.objectStore("tools");

        const request = toolsIndex.add(newToolToAdd);

        request.onsuccess = function (e) {
          console.log("Интрумент добавлен в хранилище", e);
        };

        const toolRaw = document.createElement("tr");
        const name = document.createElement("td");
        const number = document.createElement("td");
        const comment = document.createElement("td");
        const removeButton = document.createElement("td");

        name.textContent = toolName;
        number.textContent = toolNumber;
        comment.textContent = toolComment;
        removeButton.innerHTML =
          '<button onclick="RemoveTool(' +
          `'${toolName}'` +
          ')">Удалить инструмент</button>';
        toolRaw.setAttribute("id", "" + toolName);
        toolRaw.appendChild(name);
        toolRaw.appendChild(number);
        toolRaw.appendChild(comment);
        toolRaw.appendChild(removeButton);
        document.getElementById("ToolList").appendChild(toolRaw);
      }

      function RemoveTool(id) {
        console.log("id", id);
        const db = openRequest.result;
        const transaction = db.transaction("tools", "readwrite");

        const store = transaction.objectStore("tools");
        store.delete(id);
        const ToolList = document.getElementById("ToolList");
        const ToolToDelete = document.getElementById("" + id);
        console.log("Tools", ToolList, ToolToDelete);
        ToolList.removeChild(ToolToDelete);
        // db.transaction(function (tx) {
        //   tx.executeSql("DELETE FROM Molecules WHERE id=?", [id], function () {
        //     //Динамически удаляем молекулы из таблицы
        //     var MoleculeTable = document.getElementById("Molecules");
        //     var MoleculeToDelete = document.getElementById("c" + id);
        //     MoleculeTable.removeChild(MoleculeToDelete);
        //   });
        // });
      }

      // window.addEventListener("load", ListOfMolecules, true);
    </script>
  </head>
  <body>
    <div id="container">
      <section id="input">
        <h1>Добавить Инструмент</h1>

        <table border="1" cellspacing="0">
          <tr>
            <td>Название Инструмента:</td>
            <td><input type="text" id="toolname" /></td>
          </tr>
          <tr>
            <td>Количество</td>
            <td><input type="text" id="toolNumber" /></td>
          </tr>
          <tr>
            <td>Комментарий</td>
            <td><input type="text" id="toolComment" /></td>
          </tr>
        </table>
        <br />

        <button onclick="AddMolecule()">Добавить инструмент</button>
      </section>
      <section id="output">
        <h1>Просмотр списка инструментов</h1>
        <table id="ToolList" border="1" cellspacing="0">
          <td>Название:</td>
          <td>Количество:</td>
          <td>Комментарий:</td>
          <td>Удалить инструмент:</td>
        </table>
      </section>
    </div>
  </body>
</html>
